<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="ISO-8859-1">
<title>Classificador por Triades</title>

<style>
body {
    font-family: Verdana, Arial, sans-serif;
    font-size: 12px;
    margin: 10px;
}
textarea {
    width: 100%;
    height: 120px;
}
input[type=file] {
    margin-bottom: 10px;
}
button {
    margin-top: 10px;
}
pre {
    background: #f0f0f0;
    padding: 10px;
    height: 220px;
    overflow: auto;
}
</style>
</head>

<body>

<h3>Arquivo CSV de Categorias</h3>
<input type="file" id="csvFile" accept=".csv">

<h3>Texto para Analise (somente o primeiro)</h3>
<textarea id="texto"></textarea>

<button onclick="analisar()">Analisar</button>

<h3>Pontuacao por Categoria</h3>
<pre id="pontuacao"></pre>

<h3>DEBUG</h3>
<pre id="debug"></pre>

<script>
function normalizar(t) {
    t = t.toLowerCase();
    t = t.replace(/[^a-z0-9\s]/g, " ");
    t = t.replace(/\s+/g, " ");
    return t;
}

function analisar() {

    var arquivo = document.getElementById("csvFile").files[0];
    if (!arquivo) {
        alert("Selecione o CSV de categorias");
        return;
    }

    var texto = normalizar(document.getElementById("texto").value);

    var reader = new FileReader();
    reader.onload = function(e) {

        var csv = e.target.result;
        var linhas = csv.split(/\r?\n/);
        linhas.shift(); // remove cabecalho

        var scores = {};
        var debug = "";

        for (var i = 0; i < linhas.length; i++) {

            if (!linhas[i]) continue;

            var partes = linhas[i].split(",");
            if (partes.length < 3) continue;

            var categoria = partes[0].trim();
            var triade = partes[1].trim();
            var peso = parseFloat(partes[2]);

            var termos = triade.split(";");
            var encontrados = [];

            for (var j = 0; j < termos.length; j++) {

                var termo = normalizar(termos[j]);

                if (termo && texto.indexOf(termo) !== -1) {
                    encontrados.push(termos[j]);
                }
            }

            if (encontrados.length > 0) {

                var fracao = encontrados.length / termos.length;
                var score = peso * fracao;

                if (!scores[categoria]) {
                    scores[categoria] = 0;
                }
                scores[categoria] += score;

                debug += "Categoria: " + categoria + "\n";
                debug += "Triade: " + triade + "\n";
                debug += "Encontradas: " + encontrados.join(" | ") + "\n";
                debug += "Score aplicado: " + score.toFixed(4) + "\n\n";
            }
        }

        var saida = "";
        for (var c in scores) {
            saida += c + ": " + scores[c].toFixed(4) + "\n";
        }
        document.getElementById("pontuacao").textContent = saida;

        var vencedora = "";
        var maior = 0;

        for (var c in scores) {
            if (scores[c] > maior) {
                maior = scores[c];
                vencedora = c;
            }
        }

        if (vencedora !== "") {
            debug += "=============================\n";
            debug += "CATEGORIA GANHADORA:\n";
            debug += vencedora + " (score: " + maior.toFixed(4) + ")\n";
        }

        document.getElementById("debug").textContent = debug;
    };

    reader.readAsText(arquivo, "ISO-8859-1");
}
</script>

</body>
</html>


