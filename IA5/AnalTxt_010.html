<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="ISO-8859-1">
<title>AnalTxt 010</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
textarea { width: 100%; height: 180px; }
pre { background: #f4f4f4; padding: 10px; white-space: pre-wrap; }
button { padding: 10px 20px; margin-top: 10px; }
</style>
</head>
<body>

<h2>AnalTxt 010</h2>

<label>CSV de Triades:</label><br>
<input type="file" id="csvFile" accept=".csv"><br><br>

<label>Texto para analise:</label><br>
<textarea id="texto"></textarea><br>

<button id="analisar">Analisar</button>

<h3>Resultado</h3>
<pre id="resultado"></pre>

<h3>Debug</h3>
<pre id="debug"></pre>

<script>
/* ================= NORMALIZACAO ================= */

function normalizarToken(t) {
    t = t.toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9]/g,"");

    if (t.endsWith("oes")) t = t.slice(0,-3) + "ao";
    else if (t.endsWith("ais")) t = t.slice(0,-3) + "al";
    else if (t.endsWith("res")) t = t.slice(0,-2);
    else if (t.endsWith("s") && t.length > 3) t = t.slice(0,-1);

    return t;
}

function normalizarTexto(txt) {
    return txt
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9\s]/g," ")
        .replace(/\s+/g," ")
        .trim()
        .split(" ")
        .map(normalizarToken)
        .filter(p => p.length > 1);
}

/* ================= PRECEDENCIA ================= */

const precedencia = [
    "EMERGENCIA ENCHENTES",
    "EMERGENCIA PUBLICA",
    "QUALIDADE DA AGUA",
    "FALTA DE AGUA",
    "INFRAESTRUTURA (SANEAMENTO)",
    "INFRAESTRUTURA VIARIA",
    "SERVICOS",
    "QUALIDADE"
];

/* ================= CSV ================= */

let triades = [];

document.getElementById("csvFile").addEventListener("change", function(e) {
    const reader = new FileReader();
    reader.onload = function() {
        triades = [];
        const linhas = reader.result.split(/\r?\n/);
        linhas.forEach(l => {
            if (!l.trim()) return;
            const p = l.split(",");
            if (p.length < 3) return;

            triades.push({
                categoria: p[0].trim(),
                termos: p[1].split(";").map(t => normalizarToken(t.trim())),
                peso: parseFloat(p[2].replace(",", "."))
            });
        });
    };
    reader.readAsText(e.target.files[0], "ISO-8859-1");
});

/* ================= ANALISE ================= */

document.getElementById("analisar").addEventListener("click", function() {

    const texto = document.getElementById("texto").value;
    const palavras = normalizarTexto(texto);

    let scores = {};
    let debug = "";

    triades.forEach(t => {
        let encontrados = [];

        t.termos.forEach(term => {
            if (palavras.includes(term)) {
                encontrados.push(term);
            }
        });

        let qtd = encontrados.length;
        let total = t.termos.length;
        let fracao = qtd / total;

        /* >>> AJUSTE SOLICITADO: DEBUG SO COM MATCH <<< */
        if (qtd > 0) {
            debug += "Categoria: " + t.categoria + "\n";
            debug += "Triade: " + t.termos.join(";") + "\n";
            debug += "Encontrados: " + encontrados.join(", ") + "\n";
        }

        if (fracao >= (1 / total)) {
            let score = fracao * t.peso;

            if (!scores[t.categoria]) {
                scores[t.categoria] = { score: 0, detalhes: [] };
            }

            scores[t.categoria].score += score;
            scores[t.categoria].detalhes.push(
                t.termos.join(";") + " => " + score.toFixed(4)
            );

            if (qtd > 0) {
                debug += "Score aplicado: " + score.toFixed(4) + "\n\n";
            }
        }
    });

    let vencedora = null;
    let maiorScore = 0;

    for (let c in scores) {
        if (scores[c].score > maiorScore) {
            maiorScore = scores[c].score;
            vencedora = c;
        }
    }

    let candidatas = Object.keys(scores).filter(c => scores[c].score > 0);
    for (let p of precedencia) {
        if (candidatas.includes(p)) {
            vencedora = p;
            break;
        }
    }

    let resultado = "";
    if (!vencedora) {
        resultado = "Nenhuma categoria reconhecida.";
    } else {
        resultado = "Categoria vencedora: " + vencedora + "\n";
        resultado += "Score total: " + scores[vencedora].score.toFixed(4) + "\n\n";
        resultado += "Triades:\n";
        scores[vencedora].detalhes.forEach(d => {
            resultado += "- " + d + "\n";
        });
    }

    document.getElementById("resultado").textContent = resultado;
    document.getElementById("debug").textContent = debug;
});
</script>

</body>
</html>
